<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empleados</title>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js'></script>

    <script src="https://kit.fontawesome.com/bbb62af81d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../../style/css/ge/empleados.css">
</head>

<body>
    <main class="main">
        <section>
            <h2>Gestion de Empleados</h2>
        </section>

        <section>
            <article>
                <h3>Lista de Empleados</h3>
            </article>

            <article>
                <div class="search">
                    <input type="text" placeholder="Search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
            </article>

            <article class="state_selection">
                <div class="selected">
                    <p>Activo</p>
                    <input type="hidden" value="1">
                </div>
                <div>
                    <p>Inactivo</p>
                    <input type="hidden" value="0">
                </div>
            </article>

            <article>
                <div class="card_list">
                    <div class="card">
                        <div class="colum">
                            <p>Nombre: <label id="name">Lorem</label></p>
                            <p>Apellido: <label id="lastname">Lorem</label></p>
                            <p>Ci: <label id="ci"></label></p>
                        </div>
                        <div class="colum">
                            <div class="switch">
                                <input class="input_switch" type="checkbox" checked disabled />
                                <label class="label_switch"></label>
                                <div />
                            </div>
                        </div>
                    </div>
            </article>
        </section>

        <section>
            <h3>Empleado</h3>
            <article class="card_selected">
                <div class="input_container">
                    <input type="text" id="ci" class="input_text" value="nom" required disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">CI:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="contrasena" class="input_text" value="ap" required disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Contrase√±a:</label>
                </div>
                <!-- //tipo usuario -->
                <div class="input_container">
                    <input type="text" id="nombres" class="input_text" required>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Nombres:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="apellidos" class="input_text" required>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Apellidos:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="telefono" class="input_text" required>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Telefono:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="nombres" class="input_text" required>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Sucursal:</label>
                </div>
                <div class="input_container">
                    <div class="switch">
                        <input class="input_switch" id="state" type="checkbox" />
                        <label class="label_switch" for="state"></label>
                        <div />
                    </div>
                </div>
            </article>
            <article class="options">
                <div class="edit">
                    <button type="button" id="edit"><span>Editar</span></button>
                    <button type="button" id="save_edit"><span>Guardar Cambios</span></button>
                </div>
                <div class="delete">
                    <button type="button" id="off"><span>Dar de baja</span></button>
                    <button type="button" id="on"><span>Activar</span></button>
                    <!-- <button type="button" id="on">Activar</button> -->
                </div>
            </article>
        </section>
    </main>
</body>
<script>
    $(document).ready(function () {
        // Selecionar botones activo/Inactivo
        $(".state_selection div").click(function () {
            $(".state_selection div").removeClass("selected");
            $(this).addClass("selected");
            $(".search input").val("")
        });
    });
</script>
<script type="text/javascript">
    $(document).ready(function () {
        create_employee_card_list({ state: 1 });

        $(".state_selection div").click(function () {
            create_employee_card_list({ state: $(this).find("input[type='hidden']").val() });
        });

        $(".search input").on("input", function (event) {
            let search = $(this).val();
            let state = $(".state_selection .selected input").val();
            if (search.length >= 1) {
                create_employee_card_list({ state: state, search: search });
            } else {
                create_employee_card_list({ state: state });
            }
        });

        $(".options").hide();
    });

    function get_empleados(parameters) {
        let url_php = "get_empleados.php";
        url_php = "../../php/ge/" + url_php;

        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url_php,
                method: "post",
                dataType: "json",
                data: parameters,
                success: function (response) {
                    resolve(response);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    function get_sucursales(parameters) {
        let url_php = "get_sucursales.php";
        url_php = "../../php/ge/" + url_php;

        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url_php,
                method: "post",
                dataType: "json",
                data: parameters,
                success: function (response) {
                    resolve(response);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    function create_employee_card_list(state) {
        let card_list = "";
        get_empleados(state)
            .then(function (response) {
                // Creamos una tarjeta por cada registro
                response.forEach(element => {
                    card_list += create_employee_card(element);
                });
                $(".card_list").html(card_list);

                // Seleccionar empleado
                $(".card").click(function () {
                    var ci = $(this).find("#ci").text();
                    get_empleados({ ci: ci })
                        .then(function (response) {
                            selected_employee_card(response[0])
                        })
                        .catch(function (error) {
                            console.log('%c%s', 'color: #ff0000', error);
                        });
                });
            })
            .catch(function (error) {
                console.log('%c%s', 'color: #ff0000', error);
            });
    }

    function create_employee_card(employee) {
        let employee_state = employee.estado === 1 ? "checked" : "";
        return card = `
            <div class="card">
                <div class="column">
                    <p>Nombre: <label id="name">${employee.nombres}</label></p>
                    <p>Apellido: <label id="lastname">${employee.apellidos}</label></p>
                    <p>Ci: <label id="ci">${employee.usuario.ci}</label></p>
                </div>
                <div class="column">
                    <label class="switch">
                        <input class="input_switch" type="checkbox" ${employee_state} disabled/>
                        <label class="label_switch"></label>
                    </label>
                </div>
            </div>
        `;
    }



    function selected_employee_card(employee) {
        get_sucursales({ state: 1 }).then(function (sucursales) {
            const selector = `
                <select id="sucursales_list" disabled>
                    ${sucursales.map(sucursal => {
                const selected = sucursal.id === employee.sucursal.id_sucursal ? " selected" : "";
                return `<option value="${sucursal.id}"${selected}>${sucursal.nombre}</option>`;
            }).join('')}
                </select>`;

            const employee_state = employee.estado === 1 ? "checked" : "";

            $(".card_selected").html(`
                <div class="input_container">
                    <input type="text" id="ci" class="input_text" value="${employee.usuario.ci}" disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">CI:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="contrasena" class="input_text" value="${employee.usuario.contrasena}" disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Contrase√±a:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="nombres" class="input_text" value="${employee.nombres}" disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Nombres:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="apellidos" class="input_text" value="${employee.apellidos}" disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Apellidos:</label>
                </div>
                <div class="input_container">
                    <input type="text" id="telefono" class="input_text" value="${employee.telefono}" disabled>
                    <span class="highlight"></span>
                    <span class="bar"></span>
                    <label class="label_text">Telefono:</label>
                </div>
                <div class="input_container">
                    ${selector}
                </div>
                <div class="input_container">
                    <div class="switch">
                        <input class="input_switch" id="state" type="checkbox" ${employee_state} disabled>
                        <label class="label_switch" for="state"></label>
                    </div>
                </div>
            `);

            $(".options").show();
            $(".options .edit #save_edit").hide();
            if (employee.estado) {
                $(".options .delete #on").hide();
                $(".options .delete #off").show();
            } else {
                $(".options .delete #on").show();
                $(".options .delete #off").hide();
            }
        })
    }
</script>
<!-- delete -->
<script>
    function delete_empleado(state, ci) {
        let url_php = "delete_empleado.php";
        url_php = "../../php/ge/" + url_php;

        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url_php,
                method: "post",
                dataType: "json",
                data: {
                    state: state,
                    ci: ci,
                },
                success: function (response) {
                    resolve(response);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    $(document).ready(function () {
        $(".options .delete #off").click(function () {
            activate_empleado(this);
        });
        $(".options .delete #on").click(function () {
            desactivate_empleado(this);
        });
    });

    function activate_empleado(button) {
        button.disabled = true;
        let state = $(".card_selected #state").prop("checked") ? 0 : 1;
        let ci = $(".card_selected #ci").val();
        console.log('%c%s', 'color: #fff', ci);
        delete_empleado(state, ci).then(function (response) {
            console.log(response);
            console.log(JSON.stringify(response));
            button.disabled = false;
        }).catch(function (error) {
            console.log('%c%s', 'color: #731d6d', error);
        });
    }


    function desactivate_empleado(button) {
        button.disabled = true;
        let state = $(".card_selected #state").prop("checked") ? 0 : 1;
        let ci = $(".card_selected #ci").val();
        console.log('%c%s', 'color: #fff', ci);
        delete_empleado(state, ci).then(function (response) {
            console.log(response);
            console.log(JSON.stringify(response));
            button.disabled = false;
        }).catch(function (error) {
            console.log('%c%s', 'color: #731d6d', error);
        });
    }
</script>

<script type="text/javascript">
    function edit_empleado(ci, contrasena, nombres, apellidos, telefono, id_sucursal) {
        let url_php = "edit_empleado.php";
        url_php = "../../php/ge/" + url_php;

        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url_php,
                method: "post",
                dataType: "json",
                data: { ci, contrasena, nombres, apellidos, telefono, id_sucursal },
                success: function (response) {
                    resolve(response);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    $(document).ready(function () {
        $(".options .edit #edit").click(function () {
            get_empleado_edit_data(this);
        });
        $(".options .edit #save_edit").click(function () {
            save_edit_empleado(this);
        });
    });



    function get_empleado_edit_data(button) {
        // $(".card_selected #ci").removeAttr("disabled");
        $(".card_selected #contrasena").removeAttr("disabled");
        $(".card_selected #nombres").removeAttr("disabled");
        $(".card_selected #apellidos").removeAttr("disabled");
        $(".card_selected #telefono").removeAttr("disabled");
        $(".card_selected #sucursales_list").removeAttr("disabled");

        $(".options .edit #edit").hide();
        $(".options .edit #save_edit").show();
    }

    function save_edit_empleado(button) {
        button.disabled = true;
        var cardSelected = $(".card_selected");
        let ci = cardSelected.find("#ci").val();
        let contrasena = cardSelected.find("#contrasena").val();
        let nombres = cardSelected.find("#nombres").val();
        let apellidos = cardSelected.find("#apellidos").val();
        let telefono = cardSelected.find("#telefono").val();
        let id_sucursal = cardSelected.find("#sucursales_list").val();

        console.log(ci, contrasena, nombres, apellidos, telefono, id_sucursal);
        edit_empleado(ci, contrasena, nombres, apellidos, telefono, id_sucursal)
            .then(function (response) {
                $(".card_selected #contrasena").prop("disabled", true);
                $(".card_selected #nombres").prop("disabled", true);
                $(".card_selected #apellidos").prop("disabled", true);
                $(".card_selected #telefono").prop("disabled", true);
                $(".card_selected #sucursales_list").prop("disabled", true);

                $(".options .edit #save_edit").hide();
                $(".options .edit #edit").show();
                button.disabled = false;
            });
    }
</script>

</html>